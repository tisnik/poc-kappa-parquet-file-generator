<!DOCTYPE html>
<!--
 Copyright 2020 Red Hat, Inc

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<html>
<head>
<title>db-writer.go</title>
<meta charset="utf-8"/>
<style type="text/css">body {
    background: rgb(225, 225, 225);
    margin: 0px;
    padding: 0px;
}

#docgo p {
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo div {
    display: inline;
}

#docgo #background {
    position: fixed;
    top: 0; left: 525px; right: 0; bottom: 0;
    background: rgb(47, 47, 47);
    border-left: 1px solid #e5e5ee;
    z-index: -1;
}

#docgo .keyword {
    color: rgb(250, 200, 100);
}

#docgo .literal {
    color: rgb(140, 190, 100);
}

#docgo .ident {
    color: white;
}

#docgo .operator {
    color: white;
}

#docgo .comment {
}

#docgo h1, h2, h3, h4, h5 {
    text-align: left;
    margin-top: 0px;
    margin-right: 0px;
    margin-bottom: 15px;
    margin-left: 0px;
}

#docgo h1 {
    margin-top: 40px;
}

#docgo .doc {
    vertical-align: top;
    font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
    font-size: 15px;
    line-height: 22px;
    color: black;
    min-width: 450px;
    max-width: 450px;
    padding-top: 10px;
    padding-right: 25px;
    padding-bottom: 1px;
    padding-left: 50px;
    overflow-x: hidden;
}

#docgo .code {
    min-width: 650px;
    max-width: 650px;
    padding-left: 25px;
    padding-right: 15px;
    border-left: 1px;
    overflow-x: hidden;
    vertical-align: top;
}

#docgo .code pre code  {
    font-size: 12px;
    line-height: 18px;
    font-family: Menlo, Monaco, Consolas, "Lucida Console", monospace;
    color: rgb(120, 120, 120);
}
</style>
</head>
<body>
<div id="docgo">
  <div id="background"></div>
  <table>
    <thead><tr><th class="doc"><h1>db-writer.go</h1></th><th class="code"></th></tr></thead>
    <tbody>
      
      <tr class="section">
	<td class="doc"></td>
	<td class="code"><pre><code><div class="comment">/*
Copyright Â© 2020 Pavel Tisnovsky

Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/</div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>This tool consumes messages from selected Kafka topic and partition. Such
messages are unmarshalled, parsed, and stored into PostgreSQL database. It
is possible to use command line flags to select the database, Kafka topic,
and Kafka partition.</p>
</td>
	<td class="code"><pre><code>
<div class="keyword">package</div> <div class="ident">main</div><div class="operator"></div>

<div class="keyword">import</div> <div class="operator">(</div>
	<div class="literal">&#34;encoding/csv&#34;</div><div class="operator"></div>
	<div class="literal">&#34;encoding/json&#34;</div><div class="operator"></div>
	<div class="literal">&#34;flag&#34;</div><div class="operator"></div>
	<div class="literal">&#34;fmt&#34;</div><div class="operator"></div>
	<div class="literal">&#34;log&#34;</div><div class="operator"></div>
	<div class="literal">&#34;os&#34;</div><div class="operator"></div>
	<div class="literal">&#34;strconv&#34;</div><div class="operator"></div>
	<div class="literal">&#34;time&#34;</div><div class="operator"></div>

	<div class="literal">&#34;database/sql&#34;</div><div class="operator"></div>
	<div class="ident">_</div> <div class="literal">&#34;github.com/lib/pq&#34;</div> <div class="operator"></div><div class="comment">// PostgreSQL database driver</div>

	<div class="literal">&#34;github.com/Shopify/sarama&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>defaultBrokerAddress represents address of broker running locally.
Usually we need to communicate with this broker.</p>
</td>
	<td class="code"><pre><code><div class="keyword">const</div> <div class="ident">defaultBrokerAddress</div> <div class="operator">=</div> <div class="literal">&#34;localhost:9092&#34;</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>default values for database connector</p>
</td>
	<td class="code"><pre><code><div class="keyword">const</div> <div class="operator">(</div>
	<div class="ident">defaultDatabaseHostname</div> <div class="operator">=</div> <div class="literal">&#34;localhost&#34;</div><div class="operator"></div>
	<div class="ident">defaultDatabasePort</div>     <div class="operator">=</div> <div class="literal">5432</div><div class="operator"></div>
	<div class="ident">defaultDatabaseName</div>     <div class="operator">=</div> <div class="literal">&#34;d0&#34;</div><div class="operator"></div>
	<div class="ident">defaultDatabaseUser</div>     <div class="operator">=</div> <div class="literal">&#34;postgres&#34;</div><div class="operator"></div>
	<div class="ident">defaultDatabasePassword</div> <div class="operator">=</div> <div class="literal">&#34;postgres&#34;</div><div class="operator"></div>
<div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Metadata represents nested data structure containing report metadata</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">Metadata</div> <div class="keyword">struct</div> <div class="operator">{</div>
	<div class="ident">ClusterID</div>            <div class="ident">string</div> <div class="literal">`json:&#34;cluster_id&#34;`</div><div class="operator"></div>
	<div class="ident">ExternalOrganization</div> <div class="ident">string</div> <div class="literal">`json:&#34;external_organization&#34;`</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Report represents the overall structure of report data (messages)</p>
</td>
	<td class="code"><pre><code><div class="keyword">type</div> <div class="ident">Report</div> <div class="keyword">struct</div> <div class="operator">{</div>
	<div class="ident">Path</div>     <div class="ident">string</div>   <div class="literal">`json:&#34;path&#34;`</div><div class="operator"></div>
	<div class="ident">Metadata</div> <div class="ident">Metadata</div> <div class="literal">`json:&#34;metadata&#34;`</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>New constructor creates new instance of interface to Kafka consumer</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">New</div><div class="operator">(</div><div class="ident">brokerAddress</div> <div class="ident">string</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">sarama</div><div class="operator">.</div><div class="ident">Consumer</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">consumer</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sarama</div><div class="operator">.</div><div class="ident">NewConsumer</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="ident">brokerAddress</div><div class="operator">}</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if Kafka consumer has been initialized properly</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Fatal</div><div class="operator">(</div><div class="literal">&#34;error creating consumer&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">nil</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Print</div><div class="operator">(</div><div class="literal">&#34;consumer has been created&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">consumer</div><div class="operator">,</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>startConsumer function initializes the consumer and starts processing
messages</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">startConsumer</div><div class="operator">(</div><div class="ident">storage</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator">,</div> <div class="ident">brokerAddress</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">topicName</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">partition</div> <div class="ident">int</div><div class="operator">,</div> <div class="ident">csvWriter</div> <div class="operator">*</div><div class="ident">csv</div><div class="operator">.</div><div class="ident">Writer</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>construct Kafka consumer</p>
</td>
	<td class="code"><pre><code>	<div class="ident">consumer</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">New</div><div class="operator">(</div><div class="ident">brokerAddress</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Fatal</div><div class="operator">(</div><div class="literal">&#34;New consumer&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>Kafka consumer needs to be closed properly</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="ident">closeConsumer</div><div class="operator">(</div><div class="ident">consumer</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>construct Kafka consumer for selected topic and partition</p>
</td>
	<td class="code"><pre><code>	<div class="ident">partitionConsumer</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">consumer</div><div class="operator">.</div><div class="ident">ConsumePartition</div><div class="operator">(</div><div class="ident">topicName</div><div class="operator">,</div> <div class="ident">int32</div><div class="operator">(</div><div class="ident">partition</div><div class="operator">)</div><div class="operator">,</div> <div class="ident">sarama</div><div class="operator">.</div><div class="ident">OffsetOldest</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Fatal</div><div class="operator">(</div><div class="literal">&#34;New partition consumer&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>partition consumer needs to be closed properly</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="ident">closePartitionConsumer</div><div class="operator">(</div><div class="ident">partitionConsumer</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">consumed</div><div class="operator">,</div> <div class="ident">errors</div> <div class="operator">:=</div> <div class="ident">consumeMessages</div><div class="operator">(</div><div class="ident">storage</div><div class="operator">,</div> <div class="ident">partitionConsumer</div><div class="operator">,</div> <div class="ident">csvWriter</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">fmt</div><div class="operator">.</div><div class="ident">Printf</div><div class="operator">(</div><div class="literal">&#34;Consumed: %d\n&#34;</div><div class="operator">,</div> <div class="ident">consumed</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">fmt</div><div class="operator">.</div><div class="ident">Printf</div><div class="operator">(</div><div class="literal">&#34;Errors:   %d\n&#34;</div><div class="operator">,</div> <div class="ident">errors</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>closeConsumer function tries to close Kafka consumer and checks if the
operation was successful</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">closeConsumer</div><div class="operator">(</div><div class="ident">consumer</div> <div class="ident">sarama</div><div class="operator">.</div><div class="ident">Consumer</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">consumer</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Fatal</div><div class="operator">(</div><div class="literal">&#34;closeConsumer&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>closePartitionConsumer function tries to close Kafka partition consumer and
check if the operation was successful</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">closePartitionConsumer</div><div class="operator">(</div><div class="ident">partitionConsumer</div> <div class="ident">sarama</div><div class="operator">.</div><div class="ident">PartitionConsumer</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">partitionConsumer</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Fatal</div><div class="operator">(</div><div class="literal">&#34;closePartitionConsumer&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>consumeMessages function consumes messages from Kafka and process them
accordingly</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">consumeMessages</div><div class="operator">(</div><div class="ident">storage</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator">,</div> <div class="ident">partitionConsumer</div> <div class="ident">sarama</div><div class="operator">.</div><div class="ident">PartitionConsumer</div><div class="operator">,</div> <div class="ident">csvWriter</div> <div class="operator">*</div><div class="ident">csv</div><div class="operator">.</div><div class="ident">Writer</div><div class="operator">)</div> <div class="operator">(</div><div class="ident">int</div><div class="operator">,</div> <div class="ident">int</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">t1</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Now</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">consumed</div> <div class="operator">:=</div> <div class="literal">0</div><div class="operator"></div>
	<div class="ident">errors</div> <div class="operator">:=</div> <div class="literal">0</div><div class="operator"></div>

	<div class="keyword">for</div> <div class="operator">{</div>
		<div class="ident">msg</div> <div class="operator">:=</div> <div class="operator">&lt;-</div><div class="ident">partitionConsumer</div><div class="operator">.</div><div class="ident">Messages</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>fmt.Printf(&quot;Consumed message with key '%s' at offset %d with length %d\n&quot;, msg.Key, msg.Offset, len(msg.Value))</p>
</td>
	<td class="code"><pre><code>		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">writeMessageIntoDatabase</div><div class="operator">(</div><div class="ident">storage</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
			<div class="ident">errors</div><div class="operator">&#43;&#43;</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
		<div class="ident">consumed</div><div class="operator">&#43;&#43;</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>compute and print duration
t2 := time.Now()</p>
</td>
	<td class="code"><pre><code>		<div class="ident">since</div> <div class="operator">:=</div> <div class="ident">time</div><div class="operator">.</div><div class="ident">Since</div><div class="operator">(</div><div class="ident">t1</div><div class="operator">)</div><div class="operator"></div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>log.Println(&quot;Start time: &quot;, t1)
log.Println(&quot;End time:   &quot;, t2)</p>
</td>
	<td class="code"><pre><code>		<div class="ident">log</div><div class="operator">.</div><div class="ident">Printf</div><div class="operator">(</div><div class="literal">&#34;Consumed: %d  Offset: %d  Duration: %v&#34;</div><div class="operator">,</div> <div class="ident">consumed</div><div class="operator">,</div> <div class="ident">msg</div><div class="operator">.</div><div class="ident">Offset</div><div class="operator">,</div> <div class="ident">since</div><div class="operator">)</div><div class="operator"></div>

		<div class="ident">time</div> <div class="operator">:=</div> <div class="ident">strconv</div><div class="operator">.</div><div class="ident">FormatFloat</div><div class="operator">(</div><div class="ident">float64</div><div class="operator">(</div><div class="ident">since</div><div class="operator">)</div><div class="operator">/</div><div class="literal">1000.0</div><div class="operator">/</div><div class="literal">1000.0</div><div class="operator">,</div> <div class="literal">&#39;f&#39;</div><div class="operator">,</div> <div class="literal">1</div><div class="operator">,</div> <div class="literal">64</div><div class="operator">)</div><div class="operator"></div>

		<div class="ident">err</div> <div class="operator">=</div> <div class="ident">csvWriter</div><div class="operator">.</div><div class="ident">Write</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="ident">time</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="literal">&#34;Error writing data into CSV&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>

		<div class="ident">csvWriter</div><div class="operator">.</div><div class="ident">Flush</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="keyword">return</div> <div class="ident">consumed</div><div class="operator">,</div> <div class="ident">errors</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>writeMessageIntoDatabase function tries to write the message into database</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">writeMessageIntoDatabase</div><div class="operator">(</div><div class="ident">storage</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator">,</div> <div class="ident">message</div> <div class="operator">*</div><div class="ident">sarama</div><div class="operator">.</div><div class="ident">ConsumerMessage</div><div class="operator">)</div> <div class="ident">error</div> <div class="operator">{</div>
	<div class="keyword">var</div> <div class="ident">report</div> <div class="ident">Report</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">json</div><div class="operator">.</div><div class="ident">Unmarshal</div><div class="operator">(</div><div class="ident">message</div><div class="operator">.</div><div class="ident">Value</div><div class="operator">,</div> <div class="operator">&amp;</div><div class="ident">report</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">fmt</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="literal">&#34;Message unmarshalling&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>all info needed for insert new record into database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">key</div> <div class="operator">:=</div> <div class="ident">message</div><div class="operator">.</div><div class="ident">Key</div><div class="operator"></div>
	<div class="ident">clusterID</div> <div class="operator">:=</div> <div class="ident">report</div><div class="operator">.</div><div class="ident">Metadata</div><div class="operator">.</div><div class="ident">ClusterID</div><div class="operator"></div>
	<div class="ident">orgID</div> <div class="operator">:=</div> <div class="ident">report</div><div class="operator">.</div><div class="ident">Metadata</div><div class="operator">.</div><div class="ident">ExternalOrganization</div><div class="operator"></div>
	<div class="ident">path</div> <div class="operator">:=</div> <div class="ident">report</div><div class="operator">.</div><div class="ident">Path</div><div class="operator"></div>
	<div class="ident">value</div> <div class="operator">:=</div> <div class="ident">string</div><div class="operator">(</div><div class="ident">message</div><div class="operator">.</div><div class="ident">Value</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>prepare INSERT statement</p>
</td>
	<td class="code"><pre><code>	<div class="ident">insertStatement</div> <div class="operator">:=</div> <div class="literal">`INSERT INTO reports(key, cluster_id, external_organization, path, report) values ($1, $2, $3, $4, $5)`</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>run the INSERT statement</p>
</td>
	<td class="code"><pre><code>	<div class="ident">_</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">Exec</div><div class="operator">(</div><div class="ident">insertStatement</div><div class="operator">,</div> <div class="ident">key</div><div class="operator">,</div> <div class="ident">clusterID</div><div class="operator">,</div> <div class="ident">orgID</div><div class="operator">,</div> <div class="ident">path</div><div class="operator">,</div> <div class="ident">value</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">fmt</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="literal">&#34;Insert into DB&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">return</div> <div class="ident">err</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>everything's fine</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">return</div> <div class="ident">nil</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>initStorage iniciates connection to DB storage.</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">initStorage</div><div class="operator">(</div><div class="ident">host</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">port</div> <div class="ident">int</div><div class="operator">,</div> <div class="ident">user</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">password</div> <div class="ident">string</div><div class="operator">,</div> <div class="ident">dbname</div> <div class="ident">string</div><div class="operator">)</div> <div class="operator">(</div><div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator">,</div> <div class="ident">error</div><div class="operator">)</div> <div class="operator">{</div>
</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>connection string</p>
</td>
	<td class="code"><pre><code>	<div class="ident">psqlconn</div> <div class="operator">:=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprintf</div><div class="operator">(</div><div class="literal">&#34;host=%s port=%d user=%s password=%s dbname=%s sslmode=disable&#34;</div><div class="operator">,</div> <div class="ident">host</div><div class="operator">,</div> <div class="ident">port</div><div class="operator">,</div> <div class="ident">user</div><div class="operator">,</div> <div class="ident">password</div><div class="operator">,</div> <div class="ident">dbname</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="literal">&#34;Connecting to database: &#34;</div> <div class="operator">&#43;</div> <div class="ident">psqlconn</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>open database</p>
</td>
	<td class="code"><pre><code>	<div class="ident">db</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">sql</div><div class="operator">.</div><div class="ident">Open</div><div class="operator">(</div><div class="literal">&#34;postgres&#34;</div><div class="operator">,</div> <div class="ident">psqlconn</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Fatal</div><div class="operator">(</div><div class="literal">&#34;Postgres driver initialization&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="literal">&#34;Postgres driver initialization: OK&#34;</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check the connection</p>
</td>
	<td class="code"><pre><code>	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">db</div><div class="operator">.</div><div class="ident">Ping</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Fatal</div><div class="operator">(</div><div class="literal">&#34;Ping to Postgres&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
	<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="literal">&#34;Connection to database: OK&#34;</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">return</div> <div class="ident">db</div><div class="operator">,</div> <div class="ident">err</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>closeStorage function tries to close the connection to storage</p>
</td>
	<td class="code"><pre><code><div class="keyword">func</div> <div class="ident">closeStorage</div><div class="operator">(</div><div class="ident">storage</div> <div class="operator">*</div><div class="ident">sql</div><div class="operator">.</div><div class="ident">DB</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">storage</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Fatal</div><div class="operator">(</div><div class="literal">&#34;storage.Close:&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

<div class="keyword">func</div> <div class="ident">main</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
	<div class="keyword">const</div> <div class="ident">noTopic</div> <div class="operator">=</div> <div class="literal">&#34;&#34;</div><div class="operator"></div>
	<div class="keyword">const</div> <div class="ident">noPartition</div> <div class="operator">=</div> <div class="operator">-</div><div class="literal">1</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>filled via command line arguments</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">var</div> <div class="ident">topicName</div> <div class="ident">string</div><div class="operator"></div>
	<div class="keyword">var</div> <div class="ident">brokerAddress</div> <div class="ident">string</div><div class="operator"></div>
	<div class="keyword">var</div> <div class="ident">partition</div> <div class="ident">int</div><div class="operator"></div>

	<div class="keyword">var</div> <div class="ident">databaseHost</div> <div class="ident">string</div><div class="operator"></div>
	<div class="keyword">var</div> <div class="ident">databasePort</div> <div class="ident">int</div><div class="operator"></div>
	<div class="keyword">var</div> <div class="ident">databaseUser</div> <div class="ident">string</div><div class="operator"></div>
	<div class="keyword">var</div> <div class="ident">databasePassword</div> <div class="ident">string</div><div class="operator"></div>
	<div class="keyword">var</div> <div class="ident">databaseName</div> <div class="ident">string</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>find and parse all command line arguments</p>
</td>
	<td class="code"><pre><code>	<div class="ident">flag</div><div class="operator">.</div><div class="ident">StringVar</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">topicName</div><div class="operator">,</div> <div class="literal">&#34;topic&#34;</div><div class="operator">,</div> <div class="ident">noTopic</div><div class="operator">,</div> <div class="literal">&#34;topic name&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">flag</div><div class="operator">.</div><div class="ident">StringVar</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">brokerAddress</div><div class="operator">,</div> <div class="literal">&#34;broker&#34;</div><div class="operator">,</div> <div class="ident">defaultBrokerAddress</div><div class="operator">,</div> <div class="literal">&#34;broker address&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">flag</div><div class="operator">.</div><div class="ident">IntVar</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">partition</div><div class="operator">,</div> <div class="literal">&#34;partition&#34;</div><div class="operator">,</div> <div class="ident">noPartition</div><div class="operator">,</div> <div class="literal">&#34;partition to consume&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">flag</div><div class="operator">.</div><div class="ident">StringVar</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">databaseHost</div><div class="operator">,</div> <div class="literal">&#34;db-host&#34;</div><div class="operator">,</div> <div class="ident">defaultDatabaseHostname</div><div class="operator">,</div> <div class="literal">&#34;database host name&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">flag</div><div class="operator">.</div><div class="ident">IntVar</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">databasePort</div><div class="operator">,</div> <div class="literal">&#34;db-port&#34;</div><div class="operator">,</div> <div class="ident">defaultDatabasePort</div><div class="operator">,</div> <div class="literal">&#34;database port&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">flag</div><div class="operator">.</div><div class="ident">StringVar</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">databaseName</div><div class="operator">,</div> <div class="literal">&#34;db-name&#34;</div><div class="operator">,</div> <div class="ident">defaultDatabaseName</div><div class="operator">,</div> <div class="literal">&#34;database name&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">flag</div><div class="operator">.</div><div class="ident">StringVar</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">databaseUser</div><div class="operator">,</div> <div class="literal">&#34;db-user&#34;</div><div class="operator">,</div> <div class="ident">defaultDatabaseUser</div><div class="operator">,</div> <div class="literal">&#34;database user&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">flag</div><div class="operator">.</div><div class="ident">StringVar</div><div class="operator">(</div><div class="operator">&amp;</div><div class="ident">databasePassword</div><div class="operator">,</div> <div class="literal">&#34;db-password&#34;</div><div class="operator">,</div> <div class="ident">defaultDatabasePassword</div><div class="operator">,</div> <div class="literal">&#34;database password for given user&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">flag</div><div class="operator">.</div><div class="ident">Parse</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if topic name has been specified on command line</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">topicName</div> <div class="operator">==</div> <div class="ident">noTopic</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Fatal</div><div class="operator">(</div><div class="literal">&#34;Topic name needs to be provided on CLI&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>check if partition has been specified on command line</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">if</div> <div class="ident">partition</div> <div class="operator">==</div> <div class="ident">noPartition</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Fatal</div><div class="operator">(</div><div class="literal">&#34;Partition needs to be provided on CLI&#34;</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>try to initialize the storage</p>
</td>
	<td class="code"><pre><code>	<div class="ident">storage</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">initStorage</div><div class="operator">(</div><div class="ident">databaseHost</div><div class="operator">,</div> <div class="ident">databasePort</div><div class="operator">,</div> <div class="ident">databaseUser</div><div class="operator">,</div> <div class="ident">databasePassword</div><div class="operator">,</div> <div class="ident">databaseName</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Fatal</div><div class="operator">(</div><div class="literal">&#34;Storage init&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>storage needs to be closed properly</p>
</td>
	<td class="code"><pre><code>	<div class="keyword">defer</div> <div class="ident">closeStorage</div><div class="operator">(</div><div class="ident">storage</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">csvFileName</div> <div class="operator">:=</div> <div class="ident">fmt</div><div class="operator">.</div><div class="ident">Sprintf</div><div class="operator">(</div><div class="literal">&#34;db-writer-%d.csv&#34;</div><div class="operator">,</div> <div class="ident">partition</div><div class="operator">)</div><div class="operator"></div>
	<div class="ident">csvFile</div><div class="operator">,</div> <div class="ident">err</div> <div class="operator">:=</div> <div class="ident">os</div><div class="operator">.</div><div class="ident">Create</div><div class="operator">(</div><div class="ident">csvFileName</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Fatal</div><div class="operator">(</div><div class="literal">&#34;Create CSV file&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

	<div class="keyword">defer</div> <div class="keyword">func</div><div class="operator">(</div><div class="operator">)</div> <div class="operator">{</div>
		<div class="ident">err</div> <div class="operator">:=</div> <div class="ident">csvFile</div><div class="operator">.</div><div class="ident">Close</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>
		<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
			<div class="ident">log</div><div class="operator">.</div><div class="ident">Fatal</div><div class="operator">(</div><div class="literal">&#34;Close CSV file&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
		<div class="operator">}</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">csvWriter</div> <div class="operator">:=</div> <div class="ident">csv</div><div class="operator">.</div><div class="ident">NewWriter</div><div class="operator">(</div><div class="ident">csvFile</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">defer</div> <div class="ident">csvWriter</div><div class="operator">.</div><div class="ident">Flush</div><div class="operator">(</div><div class="operator">)</div><div class="operator"></div>

	<div class="ident">err</div> <div class="operator">=</div> <div class="ident">csvWriter</div><div class="operator">.</div><div class="ident">Write</div><div class="operator">(</div><div class="operator">[</div><div class="operator">]</div><div class="ident">string</div><div class="operator">{</div><div class="literal">&#34;Cummulative time&#34;</div><div class="operator">}</div><div class="operator">)</div><div class="operator"></div>
	<div class="keyword">if</div> <div class="ident">err</div> <div class="operator">!=</div> <div class="ident">nil</div> <div class="operator">{</div>
		<div class="ident">log</div><div class="operator">.</div><div class="ident">Println</div><div class="operator">(</div><div class="literal">&#34;Error writing header into CSV file&#34;</div><div class="operator">,</div> <div class="ident">err</div><div class="operator">)</div><div class="operator"></div>
	<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
      <tr class="section">
	<td class="doc"><p>start consuming messages and store them into opened storage</p>
</td>
	<td class="code"><pre><code>	<div class="ident">startConsumer</div><div class="operator">(</div><div class="ident">storage</div><div class="operator">,</div> <div class="ident">brokerAddress</div><div class="operator">,</div> <div class="ident">topicName</div><div class="operator">,</div> <div class="ident">partition</div><div class="operator">,</div> <div class="ident">csvWriter</div><div class="operator">)</div><div class="operator"></div>
<div class="operator">}</div><div class="operator"></div>

</code></pre></td>
      </tr>
      
    </tbody>
  </table>
</div>
</body>
</html>
